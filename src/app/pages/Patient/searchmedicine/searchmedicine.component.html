<section class="w-full min-h-screen py-8 px-4">
  <!-- Header -->
  <div class="text-center mb-8">
    <h2 class="text-4xl md:text-5xl font-bold mb-4 text-blue-800">
      Send Requests TO Pharmacies
    </h2>
    <p class="text-gray-600 text-lg">Find the best pharmacies near you to send medicine request</p>
  </div>

  <!-- Location Message (normal, above main container) -->
  @if (locationPermissionVisible) {
    <div class="w-full max-w-2xl mx-auto mb-4 p-3 rounded-lg text-center text-base font-medium bg-blue-50 text-blue-800 border border-blue-200">
      {{ locationPermissionMessage }}
      @if (locationDenied) {
        <button (click)="locationPermissionVisible = false" class="ml-4 px-3 py-1 rounded bg-red-100 text-red-700 hover:bg-red-200 text-xs">Dismiss</button>
      }
    </div>
  }

  <!-- Main Container -->
  <div class="w-full max-w-7xl mx-auto bg-white rounded-3xl shadow-2xl border border-gray-200 overflow-hidden flex flex-col lg:flex-row h-[85vh] animate-slide-up stagger-2">
    <!-- Left Panel -->
    <div class="w-full lg:w-1/4 border-r border-gray-200 flex flex-col">
      <!-- Panel Header -->
      <div class="px-6 py-6 border-b bg-gradient-to-br from-blue-50 to-indigo-50 text-center relative overflow-hidden">
        <div class="absolute inset-0 animate-shimmer opacity-30"></div>
        <div class="relative z-10">
          <h3 class="text-2xl font-bold text-blue-800 mb-2">Medicine Request</h3>
        </div>
      </div>
      <!-- Form Container -->
      <div class="p-6 overflow-y-auto flex-1 flex flex-col gap-6">
        <!-- Form -->
        <form [formGroup]="searchForm" class="flex flex-col gap-6">
          <!-- Medicine Selection -->
          <div>
            <label class="text-sm font-semibold text-gray-700 mb-2 block text-center ">Select Medicine</label>
            <div class="relative group">
              <select formControlName="medicineId"
                class="w-full bg-white border-2 border-gray-300 text-blue-800 rounded-xl px-4 py-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 hover:border-blue-400 appearance-none cursor-pointer"
                required>
                <option value="">Choose medicine</option>
                @for (med of medicines; track med.id) {
                  <option [ngValue]="med.id">{{ med.name }} ({{ med.strength }})</option>
                }
              </select>
              <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                <i class="fa-solid fa-chevron-down text-blue-600"></i>
              </div>
            </div>
          </div>
          <!-- Quantity Input -->
          <div>
            <label class="text-sm font-semibold text-gray-700 mb-2 block">Quantity</label>
            <input type="number" min="1" formControlName="quantity"
              class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-blue-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 hover:border-blue-400"
              required placeholder="Enter quantity" />
          </div>
        </form>
        <!-- Selected Medicine Display -->
        @if (selectedMedicine && selectedQuantity) {
          <div class="glass-morphism-dark rounded-xl p-4 text-blue-800 hover-lift">
            <h4 class="font-bold text-sm mb-2 flex items-center gap-2">
              <i class="fa-solid fa-pills"></i>
              Selected Medicine:
            </h4>
            <p class="text-sm mb-1">{{ selectedMedicine.name }} ({{ selectedMedicine.strength }})</p>
            <p class="text-sm text-gray-600">Quantity: {{ selectedQuantity }}</p>
          </div>
        }
        <!-- Send All Button -->
        <button class="mt-auto bg-gradient-to-r from-green-500 to-green-600 text-white py-4 px-6 rounded-xl shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 button-glow font-semibold text-base"
          [disabled]="!selectedMedicine || !selectedQuantity || !pharmacies || pharmacies.length === 0"
          (click)="sendRequestToAll()">
          <i class="fa-solid fa-paper-plane mr-2"></i>
          @if (!sendingAll) {
            <span>Send to All Pharmacies</span>
          }
          @if (sendingAll) {
            <span>
              <i class="fa-solid fa-spinner fa-spin mr-2"></i>
              Sending to All...
            </span>
          }
        </button>
      </div>
    </div>
    <!-- Right Panel -->
    <div class="w-full lg:w-3/4 overflow-y-auto bg-gradient-to-br from-gray-50 to-blue-50 p-6">
      <!-- Empty State -->
      @if (!searchDone || pharmacies.length === 0) {
        <div class="text-gray-500 text-center mt-20 animate-slide-up">
          <div class="animate-float">
            <i class="fa-solid fa-magnifying-glass text-6xl mb-4 text-blue-300"></i>
          </div>
          <p class="text-xl">{{ searchDone && pharmacies.length === 0 ? 'No pharmacies found with the selected medicine.' : 'Select a medicine and quantity to search nearby pharmacies.' }}</p>
        </div>
      }
      <!-- Pharmacy Cards -->
      @if (searchDone && pharmacies.length > 0) {
        <div class="space-y-6">
          @for (pharmacy of pharmacies; track pharmacy.pharmacyID) {
            <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100 hover-lift transition-all duration-300 animate-slide-right" [ngClass]="'stagger-' + ($index + 1)">
              <!-- Pharmacy Header -->
              <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                  <h3 class="text-xl font-bold text-gray-900 mb-2">{{ pharmacy.name }}</h3>
                  <div class="flex flex-wrap gap-3">
                    <div class="flex items-center gap-2 bg-blue-100 px-3 py-2 rounded-full text-sm text-blue-700">
                      <i class="fa-solid fa-location-dot"></i>
                      <span class="font-medium">{{ pharmacy.distance }} km away</span>
                    </div>
                    <div class="flex items-center gap-2 bg-green-100 px-3 py-2 rounded-full text-sm text-green-700">
                      <i class="fa-solid fa-phone"></i>
                      <span>{{ pharmacy.phonenumber }}</span>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Action Buttons -->
              <div class="flex flex-col md:flex-row gap-3">
                <button (click)="sendRequest(pharmacy)"
                  [disabled]="requestStatus[pharmacy.pharmacyID] === 'loading' || requestStatus[pharmacy.pharmacyID] === 'success'"
                  class="flex-1 py-3 px-6 rounded-xl font-semibold transition-all duration-300 button-glow"
                  [ngClass]="{
                    'bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg hover:shadow-xl': !requestStatus[pharmacy.pharmacyID] || requestStatus[pharmacy.pharmacyID] === 'error',
                    'bg-green-100 text-green-700 cursor-not-allowed': requestStatus[pharmacy.pharmacyID] === 'success',
                    'bg-gray-100 text-gray-500 cursor-not-allowed': requestStatus[pharmacy.pharmacyID] === 'loading'
                  }">
                  @if (!requestStatus[pharmacy.pharmacyID] || requestStatus[pharmacy.pharmacyID] === 'error') {
                    <span>
                      <i class="fa-solid fa-paper-plane mr-2"></i>
                      {{ requestStatus[pharmacy.pharmacyID] === 'error' ? 'Retry Request' : 'Send Request' }}
                    </span>
                  }
                  @if (requestStatus[pharmacy.pharmacyID] === 'loading') {
                    <span>
                      <i class="fa-solid fa-spinner fa-spin mr-2"></i>
                      Sending...
                    </span>
                  }
                  @if (requestStatus[pharmacy.pharmacyID] === 'success') {
                    <span>
                      <i class="fa-solid fa-check mr-2"></i>
                      Request Sent
                    </span>
                  }
                </button>
                <button (click)="openInMaps(pharmacy)"
                  class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 px-6 rounded-xl font-semibold transition-all duration-300 button-blue-glow shadow-lg hover:shadow-xl">
                  <i class="fa-solid fa-map-location-dot mr-2"></i>
                  View on Map
                </button>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>
</section>
